using Newtonsoft.Json.Linq;
using Newtonsoft.Json;
using System.Data;
using Kusto.Language.Editor;
using Kusto.Language;

namespace KustoSchemaTools.Parser
{
    public static class KustoExtensions
    {
        public static JsonSerializerSettings DefaultJsonSettings = new JsonSerializerSettings
        {
            NullValueHandling = NullValueHandling.Ignore,
            Formatting = Formatting.Indented,
            ContractResolver = new Newtonsoft.Json.Serialization.CamelCasePropertyNamesContractResolver()
            

        };

        public static string BracketIfIdentifier(this string name)
        {
            return reservedKustoWords.Contains(name) 
                ? $"['{name}']" 
                : name.StartsWith("[") 
                    ? name
                    : KustoFacts.BracketNameIfNecessary(name);
        }


        public static List<T> As<T>(this IDataReader reader)
        {
            var table = new DataTable();
            table.Load(reader);
            return As<T>(table);
        }

        public static JObject AsDynamic(this IDataReader reader)
        {
            var table = new DataTable();
            table.Load(reader);
            return AsDynamic(table);
        }

        public static T ToScalar<T>(this IDataReader reader)
        {
            if (reader.Read())
            {
                return (T)reader.GetValue(0);
            }
            throw new InvalidOperationException("Can't get the value from the resultset, because it is empty.");
        }

        public static List<T> As<T>(this DataTable table)
        {
            var json = JsonConvert.SerializeObject(table);
            return JsonConvert.DeserializeObject<List<T>>(json, DefaultJsonSettings);
        }

        public static JObject AsDynamic(this DataTable table)
        {
            var json = JsonConvert.SerializeObject(table);
            return JObject.Parse(json);
        }

        public static string ToKustoClusterUrl(this string cluster, bool ingest = false)
        {
            var ingestPrefix = ingest ? "ingest-" : "";
            return cluster.StartsWith("https") ? cluster : $"https://{ingestPrefix}{cluster}.kusto.windows.net";
        }


        public static string PrettifyKql(this string query)
        {
            return new KustoCodeService(KustoCode.Parse(query)).GetFormattedText().Text;
        }

        public static string UseHtmlLineBreaks(this string query)
        {
            return query.Replace("\r", "").Replace("\n", "<br>");
        }


        static HashSet<string> reservedKustoWords = new HashSet<string>
        {
            "access",
            "account",
            "accounts",
            "accumulate",
            "activitystate",
            "add",
            "adl",
            "admin",
            "admins",
            "aggregations",
            "alias",
            "all",
            "alldatabasesadmins",
            "alldatabasesmonitors",
            "alldatabasesviewers",
            "alter",
            "alter-merge",
            "and",
            "anomalycolumns",
            "append",
            "apply",
            "artifacts",
            "as",
            "asc",
            "assert-schema",
            "assignment",
            "assignments",
            "async",
            "attach",
            "autoUpdateSchema",
            "auto_delete",
            "avro",
            "apacheavro",
            "axes",
            "base",
            "based-on",
            "basicauth",
            "between",
            "bin",
            "blob",
            "block",
            "blocked",
            "by",
            "cache",
            "caching",
            "cachingpolicy",
            "call-tree",
            "callout",
            "cancel",
            "capacity",
            "catalog",
            "certificates",
            "classification",
            "clean",
            "clear",
            "cloudsettings",
            "cluster",
            "column",
            "columns",
            "column-docstrings",
            "commands",
            "commands-and-queries",
            "commconcurrency",
            "commpools",
            "compact",
            "completed",
            "compressed",
            "consume",
            "contains",
            "continuous",
            "continuous-export",
            "continuous-exports",
            "continuous-job",
            "conservative",
            "copy",
            "corrupted",
            "count",
            "crash",
            "create",
            "create-or-alter",
            "createdon",
            "create-merge",
            "credstore",
            "csl",
            "cslschema",
            "csv",
            "cursor",
            "data",
            "database",
            "databasecreators",
            "databases",
            "dataexport",
            "data-export",
            "dataformat",
            "data_movement_restriction",
            "datatable",
            "declare",
            "decryption-certificate-thumbprint",
            "default",
            "define",
            "delete",
            "delta",
            "desc",
            "detach",
            "details",
            "diagnostics",
            "disable",
            "distinct",
            "dnshostname",
            "docstring",
            "drop",
            "drop-pretend",
            "dup-next-failed-ingest",
            "dup-next-ingest",
            "earliest",
            "echo",
            "edges",
            "effective",
            "enable",
            "encoding",
            "encodingpolicy",
            "entities",
            "entity",
            "entity_group",
            "entity_groups",
            "ephemeral",
            "escape",
            "evaluate",
            "except",
            "execute",
            "export",
            "extend",
            "extent",
            "extentcontainers",
            "extents",
            "extentsmerge",
            "extents-merge",
            "extents-partition",
            "extent_tags_retention",
            "external",
            "external-artifacts",
            "externaldata",
            "external_data",
            "fabric",
            "fabriccache",
            "fabricclocks",
            "fabriclocks",
            "facet",
            "failures",
            "featureflags",
            "filter",
            "find",
            "first",
            "flags",
            "flush",
            "folder",
            "fork",
            "freshness",
            "from",
            "function",
            "functions",
            "generic",
            "get",
            "getschema",
            "granny-asc",
            "granny-desc",
            "granularity",
            "greedy",
            "groups",
            "harddelete",
            "hardretention",
            "has",
            "has_all",
            "has_any",
            "hash",
            "hidden",
            "hot",
            "hotdata",
            "hotindex",
            "hours",
            "id",
            "if_later_than",
            "ifexists",
            "ifnotexists",
            "in",
            "in~",
            "info",
            "ingest",
            "ingest-from-storage",
            "ingest-inline",
            "ingestion",
            "ingestionbatching",
            "ingestions",
            "ingestiontime",
            "ingestors",
            "inline",
            "internal",
            "into",
            "invoke",
            "journal",
            "json",
            "jobs",
            "key",
            "keys",
            "keyvault",
            "keyvaultsecrets",
            "kind",
            "kql",
            "kqlschema",
            "kv_delimiter",
            "last",
            "latest",
            "legend",
            "let",
            "limit",
            "linear",
            "list",
            "load",
            "local",
            "location",
            "lookback",
            "lookup",
            "log",
            "macro-expand",
            "maintenance_mode",
            "make-series",
            "management",
            "map",
            "mapping",
            "mappings",
            "managed_identity",
            "materialize",
            "materialized-view",
            "materialized-views",
            "materialized-view-combine",
            "maxRecords",
            "mdm",
            "memory",
            "mempools",
            "merge",
            "metadata",
            "method",
            "mirroring",
            "missing",
            "monitoring",
            "monitors",
            "move",
            "multidatabaseadmins",
            "mv-apply",
            "mv-expand",
            "mvapply",
            "mvexpand",
            "nan",
            "node",
            "nodes",
            "none",
            "!between",
            "!in",
            "!in~",
            "null",
            "nulls",
            "of",
            "on",
            "older",
            "operation",
            "operations",
            "ops",
            "optional",
            "or",
            "orc",
            "order",
            "others",
            "output",
            "over",
            "pack",
            "pair_delimiter",
            "panels",
            "parse",
            "parse-where",
            "parse-kv",
            "parquet",
            "partition",
            "__partitionby",
            "partitioning",
            "password",
            "patch",
            "pathformat",
            "pattern",
            "pending",
            "period",
            "periodic-storage-artifacts-cleanup",
            "persist",
            "plotly",
            "plugin",
            "plugins",
            "policies",
            "policy",
            "pretend",
            "prettyname",
            "primary",
            "principal",
            "principals",
            "print",
            "project",
            "project-away",
            "project-keep",
            "project-rename",
            "project-reorder",
            "project-smart",
            "purge",
            "purge-cleanup",
            "purge-storage-artifacts-cleanup",
            "queries",
            "query",
            "query_parameters",
            "queryexecution",
            "queryplan",
            "query_weak_consistency",
            "query_results",
            "quote",
            "range",
            "readonly",
            "readwrite",
            "reason",
            "rebuild",
            "record",
            "records",
            "recycle",
            "reduce",
            "regex",
            "remote-schema",
            "rename",
            "render",
            "replace",
            "resources",
            "restore",
            "restrict",
            "restricted_view_access",
            "resume",
            "resume-purges",
            "retention",
            "request_classification",
            "request_support",
            "roles",
            "row_level_security",
            "roworder",
            "roworderpolicy",
            "rowstore",
            "rowstorepolicy",
            "rowstore_references",
            "rowstores",
            "rowstore_sealinfo",
            "run",
            "running",
            "sample",
            "sample-distinct",
            "sandbox",
            "sandboxes",
            "save",
            "scalein",
            "scan",
            "schema",
            "script",
            "seal",
            "seals",
            "search",
            "secrets",
            "serialize",
            "sensitive",
            "series",
            "service",
            "servicepoints",
            "services",
            "set",
            "set-or-append",
            "set-or-replace",
            "sharedcontainers",
            "sharding",
            "shards",
            "shard-groups",
            "shards-group",
            "shards_grouping",
            "show",
            "softdelete",
            "softretention",
            "sort",
            "sql",
            "stacked",
            "stacked100",
            "state",
            "stats",
            "status",
            "statistics",
            "step",
            "storedqueryresultcontainers",
            "stream",
            "streamingingestion",
            "streamingingestion_maintenance_mode",
            "streaming-ingestion-post-processing",
            "stored-query-results",
            "summarize",
            "sstream",
            "storage",
            "suspend",
            "system_properties",
            "systemdb",
            "table",
            "tablepurge",
            "table-purge",
            "table_mirroring_template",
            "table_mirroring_templates",
            "tables",
            "tags",
            "take",
            "tcpconnections",
            "tcpports",
            "tempstorage",
            "tenants",
            "threadpools",
            "threshold",
            "throw",
            "title",
            "to",
            "top",
            "top-hitters",
            "top-nested",
            "toscalar",
            "totable",
            "trace",
            "traces",
            "traceresults",
            "tsv",
            "type",
            "typeof",
            "undo",
            "unstacked",
            "unrestrictedviewers",
            "update",
            "usage",
            "user",
            "users",
            "using",
            "uuid",
            "verbose",
            "version",
            "view",
            "views",
            "viewers",
            "virtual_cluster",
            "virtual_clusters",
            "visible",
            "volatile",
            "v9",
            "v10",
            "w3clogfile",
            "warm",
            "warming",
            "whatif",
            "where",
            "with",
            "workload_group",
            "workload_groups",
            "writeaheadlog",
            "xaxis",
            "xcolumn",
            "xmin",
            "xmax",
            "xtitle",
            "yaxis",
            "ycolumns",
            "ymin",
            "ymax",
            "ysplit",
            "ytitle",
            "bool",
            "boolean",
            "int8",
            "char",
            "uint8",
            "byte",
            "int16",
            "uint16",
            "int",
            "int32",
            "uint",
            "uint32",
            "long",
            "int64",
            "ulong",
            "uint64",
            "float",
            "real",
            "double",
            "string",
            "time",
            "timespan",
            "date",
            "datetime",
            "guid",
            "uniqueid",
            "dynamic",
            "decimal",
            "complete",
            "job",
            "kuiper",
            "start",
            "task",
            "tasks",
            "GB",
            "MB",
            "application",
            "blockedprincipals",
            "bytes",
            "callstacks",
            "concurrency",
            "configuration",
            "container",
            "containers",
            "datasize",
            "datastats",
            "datetime_pattern",
            "days",
            "dimensions",
            "disabled",
            "dryrun",
            "empty",
            "enabled",
            "exclude",
            "expired_tables_cleanup",
            "extentsize",
            "follower",
            "for",
            "format_datetime",
            "hot_window",
            "identity",
            "include",
            "network",
            "recoverability",
            "startofday",
            "startofmonth",
            "startofweek",
            "startofyear",
            "stored_query_result",
            "stored_query_results",
            "transactions",
            "trim",
            "union",
            "until",
            "unused",
            "utilization",
            "violations",
            "3Dchart",
            "__contextual_datatable",
            "__crossCluster",
            "__crossDB",
            "__executeAndCache",
            "__id",
            "__isFuzzy",
            "__noWithSource",
            "__packedColumn",
            "__projectAway",
            "__sourceColumnIndex",
            "anomalychart",
            "areachart",
            "bagexpansion",
            "barchart",
            "bin_legacy",
            "card",
            "columnchart",
            "datascope",
            "decodeblocks",
            "expandoutput",
            "force_remote",
            "hotcache",
            "isfuzzy",
            "join",
            "ladderchart",
            "linechart",
            "nooptimization",
            "piechart",
            "pivotchart",
            "relaxed",
            "scatterchart",
            "simple",
            "stackedareachart",
            "timechart",
            "timeline",
            "timepivot",
            "treemap",
            "with_itemindex",
            "with_match_id",
            "with_source",
            "with_step_name",
            "withsource"
        };


    }
}

